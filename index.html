<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ICPC Math Contest</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a25;
      --accent-blue: #3b82f6;
      --accent-cyan: #06b6d4;
      --accent-green: #22c55e;
      --accent-yellow: #eab308;
      --accent-red: #ef4444;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Space Grotesk', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    .font-display { font-family: 'Orbitron', sans-serif; }
    .bg-grid { background-image: linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px); background-size: 50px 50px; }
    .problem-cell { min-width: 70px; min-height: 45px; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    .problem-pending { background: linear-gradient(135deg, #1e3a5f 0%, #1e40af 100%); animation: pulse-pending 2s infinite; }
    .problem-wrong { background: linear-gradient(135deg, #7f1d1d 0%, #b91c1c 100%); }
    .problem-partial { background: linear-gradient(135deg, #713f12 0%, #ca8a04 100%); }
    .problem-correct { background: linear-gradient(135deg, #14532d 0%, #16a34a 100%); }
    .problem-frozen { background: linear-gradient(135deg, #1e3a5f 0%, #3b82f6 100%); position: relative; }
    .problem-frozen::after { content: '‚ùÑ'; position: absolute; top: 2px; right: 4px; font-size: 10px; opacity: 0.7; }
    @keyframes pulse-pending { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .scoreboard-row { transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease; }
    @keyframes rank-change { 0% { background: rgba(6, 182, 212, 0.3); } 100% { background: transparent; } }
    .rank-changed { animation: rank-change 1.5s ease-out; }
    .timer-display { font-variant-numeric: tabular-nums; text-shadow: 0 0 20px rgba(6, 182, 212, 0.5); }
    .timer-frozen { color: #3b82f6; text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); animation: frozen-pulse 1.5s infinite; }
    @keyframes frozen-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .upload-zone { border: 2px dashed rgba(59, 130, 246, 0.3); background: rgba(30, 58, 95, 0.1); transition: all 0.3s ease; }
    .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent-cyan); background: rgba(6, 182, 212, 0.1); }
    .btn-primary { background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-cyan) 100%); transition: all 0.3s ease; }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-content { background: var(--bg-secondary); border: 1px solid rgba(59, 130, 246, 0.2); }
    .input-field { background: var(--bg-tertiary); border: 1px solid rgba(59, 130, 246, 0.2); color: var(--text-primary); transition: all 0.3s ease; }
    .input-field:focus { outline: none; border-color: var(--accent-cyan); box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1); }
    .leaderboard-header { background: linear-gradient(180deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); }
    .status-live { animation: live-pulse 1.5s infinite; }
    @keyframes live-pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); } }
    .kbd { background: var(--bg-tertiary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; padding: 2px 6px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; }
    .rank-1 { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
    .rank-2 { color: #c0c0c0; text-shadow: 0 0 10px rgba(192, 192, 192, 0.5); }
    .rank-3 { color: #cd7f32; text-shadow: 0 0 10px rgba(205, 127, 50, 0.5); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--accent-blue); border-radius: 4px; }
  </style>
</head>
<body class="bg-grid">
  <div id="app"></div>
  <script>
    const STORAGE_KEY = 'icpc_math_contest_v3';
    
    const state = {
      mode: null,
      contestantTeam: null,
      contest: {
        name: 'Math Olympiad 2025',
        startTime: null,
        duration: 180,
        freezeTime: 30,
        partialCredit: true,
        problems: [],
        teams: {},
        submissions: [],
        isFrozen: false
      },
      judgeHistory: []
    };

    function getMode() {
      const params = new URLSearchParams(window.location.search);
      if (params.has('admin')) return 'admin';
      if (params.has('submit')) return 'contestant';
      if (params.has('scoreboard')) return 'scoreboard';
      return 'landing';
    }

    function saveContest() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state.contest)); }
    function loadContest() {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) { try { Object.assign(state.contest, JSON.parse(data)); return true; } catch(e) {} }
      return false;
    }

    function generateId() { return Math.random().toString(36).substr(2, 9); }
    function formatTime(sec) {
      if (sec < 0) sec = 0;
      const h = Math.floor(sec / 3600), m = Math.floor((sec % 3600) / 60), s = Math.floor(sec % 60);
      if (h > 0) return h + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
      return m + ':' + String(s).padStart(2,'0');
    }
    function formatTimePenalty(sec) {
      const h = Math.floor(sec / 3600), m = Math.floor((sec % 3600) / 60), s = sec % 60;
      return h + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }

    function getContestElapsed() {
      if (!state.contest.startTime) return 0;
      const now = Date.now(), start = new Date(state.contest.startTime).getTime();
      if (now < start) return 0;
      return Math.floor((now - start) / 1000);
    }
    function getRemainingTime() { return Math.max(0, state.contest.duration * 60 - getContestElapsed()); }
    function isContestStarted() { return state.contest.startTime && Date.now() >= new Date(state.contest.startTime).getTime(); }
    function isContestEnded() { return getRemainingTime() <= 0 && isContestStarted(); }
    function isFreezeTime() { const r = getRemainingTime(); return r <= state.contest.freezeTime * 60 && r > 0 && isContestStarted(); }
    function getBaseUrl() { return window.location.origin + window.location.pathname; }

    function calculateScoreboard(showFrozen = false) {
      const { teams, problems, submissions, partialCredit, startTime, duration, freezeTime } = state.contest;
      const freezeStart = (duration - freezeTime) * 60;
      const startMs = new Date(startTime).getTime();
      return Object.values(teams).map(team => {
        let totalScore = 0, totalTime = 0;
        const problemResults = {};
        problems.forEach(prob => {
          const subs = submissions.filter(s => s.teamName === team.name && s.problemId === prob.id).sort((a,b) => a.timestamp - b.timestamp);
          let best = 0, attempts = 0, solveTime = 0, pending = false, frozenCount = 0;
          subs.forEach(sub => {
            const elapsed = Math.floor((sub.timestamp - startMs) / 1000);
            const inFreeze = elapsed >= freezeStart;
            if (sub.status === 'pending') pending = true;
            else if (sub.status === 'judged' || sub.status === 'revealed') {
              if (inFreeze && sub.status !== 'revealed' && !showFrozen) { frozenCount++; }
              else { attempts++; if (sub.score > best) { best = sub.score; solveTime = elapsed; } }
            }
          });
          problemResults[prob.id] = { score: best, attempts, solveTime, hasPending: pending, frozenCount,
            status: pending ? 'pending' : frozenCount > 0 ? 'frozen' : best === 100 ? 'correct' : best > 0 ? 'partial' : attempts > 0 ? 'wrong' : 'none' };
          totalScore += best;
          if (best > 0) totalTime += solveTime + (attempts - 1) * 1200;
        });
        return { ...team, totalScore, totalTime, problemResults, solvedCount: Object.values(problemResults).filter(p => p.score === 100).length };
      }).sort((a,b) => b.totalScore !== a.totalScore ? b.totalScore - a.totalScore : a.totalTime - b.totalTime);
    }

    async function gradeSubmission(sub, prob) {
      const apiKey = "AIzaSyDWlGxZ0zItrAHfrSq3agsby6IoEhueflc";
      const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey;
      const prompt = 'You are grading a math problem. Look for "team:{name}" on the paper first.\n\nProblem image is first, solution image second.\n\nMax points: ' + prob.points + '\nPartial credit: ' + state.contest.partialCredit + '\n\nRespond ONLY as JSON:\n{"team_name": "<name or null>", "score": <0-' + prob.points + '>, "feedback": "<brief>", "detected_answer": "<answer>", "is_correct": <bool>}';
      try {
        const parts = [{ text: prompt }];
        if (prob.imageData) parts.push({ inlineData: { mimeType: prob.imageType, data: prob.imageData } });
        parts.push({ inlineData: { mimeType: sub.imageType, data: sub.imageData } });
        const res = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: 'user', parts }] }) });
        if (!res.ok) throw new Error('API ' + res.status);
        const json = await res.json();
        const raw = json?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const clean = raw.replace(/^```json\s*/i, '').replace(/```$/i, '').trim();
        const r = JSON.parse(clean);
        return { teamName: r.team_name, score: Math.round((r.score / prob.points) * 100), feedback: r.feedback, detectedAnswer: r.detected_answer, isCorrect: r.is_correct };
      } catch (e) { return { teamName: null, score: 0, feedback: 'Error: ' + e.message, detectedAnswer: '', isCorrect: false }; }
    }

    function render() {
      const app = document.getElementById('app');
      const mode = state.mode || getMode();
      if (mode === 'admin') app.innerHTML = renderAdmin();
      else if (mode === 'contestant') app.innerHTML = renderContestant();
      else if (mode === 'scoreboard') app.innerHTML = renderScoreboard();
      else app.innerHTML = renderLanding();
      attachEventListeners();
    }

    function renderLanding() {
      return '<div class="min-h-screen flex items-center justify-center p-8"><div class="text-center"><h1 class="font-display text-5xl font-black bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-500 bg-clip-text text-transparent mb-4">ICPC Math Contest</h1><p class="text-gray-400 text-lg mb-12">AI-Powered Mathematical Competition</p><div class="flex flex-col sm:flex-row gap-4 justify-center"><a href="?admin" class="px-8 py-4 rounded-xl btn-primary text-white font-bold text-lg">‚öôÔ∏è Admin Setup</a><a href="?scoreboard" class="px-8 py-4 rounded-xl bg-gray-700 hover:bg-gray-600 text-white font-bold text-lg transition">üìä Scoreboard</a></div></div></div>';
    }

    function renderAdmin() {
      const base = getBaseUrl();
      let html = '<div class="min-h-screen p-6"><div class="max-w-4xl mx-auto">';
      html += '<div class="flex items-center justify-between mb-8"><h1 class="font-display text-3xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">Admin Panel</h1><a href="?scoreboard" target="_blank" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white text-sm">üìä Scoreboard</a></div>';
      
      // Settings
      html += '<div class="modal-content rounded-2xl p-8 mb-6"><h2 class="text-xl font-bold text-white mb-6">Contest Settings</h2><div class="grid grid-cols-2 gap-6">';
      html += '<div class="col-span-2"><label class="block text-sm font-medium text-gray-300 mb-2">Contest Name</label><input type="text" id="contest-name" value="' + state.contest.name + '" class="w-full px-4 py-3 rounded-lg input-field"></div>';
      html += '<div><label class="block text-sm font-medium text-gray-300 mb-2">Start Time</label><input type="datetime-local" id="contest-start" value="' + (state.contest.startTime ? new Date(state.contest.startTime).toISOString().slice(0,16) : '') + '" class="w-full px-4 py-3 rounded-lg input-field font-mono"></div>';
      html += '<div><label class="block text-sm font-medium text-gray-300 mb-2">Duration (min)</label><input type="number" id="contest-duration" value="' + state.contest.duration + '" class="w-full px-4 py-3 rounded-lg input-field font-mono"></div>';
      html += '<div><label class="block text-sm font-medium text-gray-300 mb-2">Freeze Last (min)</label><input type="number" id="contest-freeze" value="' + state.contest.freezeTime + '" class="w-full px-4 py-3 rounded-lg input-field font-mono"></div>';
      html += '<div class="flex items-center"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" id="partial-credit" ' + (state.contest.partialCredit ? 'checked' : '') + ' class="w-5 h-5 rounded"><span class="text-gray-300">Partial Credit</span></label></div>';
      html += '</div><button id="save-settings" class="mt-6 px-6 py-3 rounded-lg btn-primary text-white font-medium">üíæ Save</button></div>';
      
      // Links
      html += '<div class="modal-content rounded-2xl p-8 mb-6"><h2 class="text-xl font-bold text-white mb-6">Share Links</h2>';
      html += '<div class="mb-4"><label class="block text-sm text-gray-300 mb-2">üì§ Contestant Link</label><div class="flex gap-2"><input type="text" readonly value="' + base + '?submit" class="flex-1 px-4 py-3 rounded-lg input-field font-mono text-sm"><button onclick="navigator.clipboard.writeText(\'' + base + '?submit\')" class="px-4 py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white">üìã</button></div><p class="text-xs text-gray-500 mt-1">Contestants write "team:{name}" on paper</p></div>';
      html += '<div><label class="block text-sm text-gray-300 mb-2">üìä Scoreboard Link</label><div class="flex gap-2"><input type="text" readonly value="' + base + '?scoreboard" class="flex-1 px-4 py-3 rounded-lg input-field font-mono text-sm"><button onclick="navigator.clipboard.writeText(\'' + base + '?scoreboard\')" class="px-4 py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white">üìã</button></div><p class="text-xs text-gray-500 mt-1">Press I/J/R for freeze controls</p></div></div>';
      
      // Problems
      html += '<div class="modal-content rounded-2xl p-8 mb-6"><div class="flex justify-between mb-6"><h2 class="text-xl font-bold text-white">Problems (Images)</h2><button id="add-problem" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-sm">+ Add</button></div><div id="problems-list" class="space-y-4">';
      state.contest.problems.forEach((p, i) => {
        html += '<div class="p-4 rounded-lg bg-gray-800/50 border border-gray-700"><div class="flex items-center gap-4 mb-3"><span class="w-10 h-10 flex items-center justify-center rounded-lg bg-blue-600 text-white font-bold">' + String.fromCharCode(65+i) + '</span><input type="text" value="' + p.name + '" class="flex-1 px-3 py-2 rounded bg-gray-700 border border-gray-600 text-white" data-field="name" data-pid="' + p.id + '"><input type="number" value="' + p.points + '" class="w-20 px-3 py-2 rounded bg-gray-700 border border-gray-600 text-white text-center" data-field="points" data-pid="' + p.id + '"><button class="p-2 text-red-400 hover:text-red-300" data-remove-problem="' + p.id + '">‚úï</button></div>';
        html += '<label class="upload-zone block rounded-lg p-4 cursor-pointer text-center" data-upload-problem="' + p.id + '">';
        if (p.imageData) html += '<img src="data:' + p.imageType + ';base64,' + p.imageData + '" class="max-h-32 mx-auto rounded mb-2"><span class="text-xs text-gray-400">Click to change</span>';
        else html += '<span class="text-gray-400">üì∑ Upload problem image</span>';
        html += '</label><input type="file" class="hidden" accept="image/*" data-problem-upload="' + p.id + '"></div>';
      });
      if (state.contest.problems.length === 0) html += '<p class="text-gray-500 text-center py-4">No problems</p>';
      html += '</div></div>';
      
      // Stats
      html += '<div class="modal-content rounded-2xl p-8 mb-6"><h2 class="text-xl font-bold text-white mb-4">Stats</h2>';
      html += '<div class="grid grid-cols-2 gap-4 mb-4"><div class="p-4 rounded-lg bg-gray-800/50"><span class="text-gray-400 text-sm">Teams</span><span class="block text-3xl font-bold text-cyan-400">' + Object.keys(state.contest.teams).length + '</span></div><div class="p-4 rounded-lg bg-gray-800/50"><span class="text-gray-400 text-sm">Submissions</span><span class="block text-3xl font-bold text-green-400">' + state.contest.submissions.length + '</span></div></div>';
      html += '<div class="flex gap-4"><button id="toggle-freeze" class="flex-1 py-3 rounded-lg ' + (state.contest.isFrozen ? 'bg-cyan-600' : 'bg-blue-600') + ' text-white font-medium">' + (state.contest.isFrozen ? 'üîì Unfreeze' : '‚ùÑÔ∏è Freeze') + '</button><button id="clear-data" class="px-6 py-3 rounded-lg bg-red-600 hover:bg-red-500 text-white font-medium">üóëÔ∏è Clear</button></div></div>';
      
      html += '</div></div>';
      return html;
    }

    function renderContestant() {
      const started = isContestStarted(), ended = isContestEnded(), remaining = getRemainingTime();
      const myBoard = state.contestantTeam ? calculateScoreboard(true).find(t => t.name === state.contestantTeam) : null;
      
      let html = '<div class="min-h-screen p-4 sm:p-6"><div class="max-w-2xl mx-auto">';
      html += '<div class="text-center mb-6"><h1 class="font-display text-2xl sm:text-3xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">' + state.contest.name + '</h1>';
      
      if (!started) html += '<div class="mt-4 p-4 rounded-lg bg-yellow-900/30 border border-yellow-700/50"><p class="text-yellow-400">‚è≥ Starts at</p><p class="text-2xl font-mono text-white">' + new Date(state.contest.startTime).toLocaleString() + '</p></div>';
      else if (ended) html += '<div class="mt-4 p-4 rounded-lg bg-red-900/30 border border-red-700/50"><p class="text-red-400 text-xl font-bold">üèÅ Contest Ended</p></div>';
      else html += '<div class="mt-4 flex justify-center"><div class="px-4 py-2 rounded-lg ' + (isFreezeTime() ? 'bg-blue-900/50' : 'bg-gray-800/50') + '"><span class="' + (isFreezeTime() ? 'text-blue-400' : 'text-cyan-400') + '">' + (isFreezeTime() ? '‚ùÑÔ∏è' : '‚è±Ô∏è') + '</span><span class="font-mono text-2xl ml-2 timer-display ' + (isFreezeTime() ? 'timer-frozen' : 'text-cyan-400') + '">' + formatTime(remaining) + '</span></div></div>';
      html += '</div>';
      
      if (state.contestantTeam) {
        html += '<div class="modal-content rounded-xl p-4 mb-6"><div class="flex items-center justify-between"><div><span class="text-gray-400 text-sm">Your Team</span><span class="block text-xl font-bold text-white">' + state.contestantTeam + '</span></div>';
        if (myBoard) html += '<div class="text-right"><span class="text-gray-400 text-sm">Score</span><span class="block text-3xl font-bold text-cyan-400">' + myBoard.totalScore + '</span></div>';
        html += '</div>';
        if (myBoard) {
          html += '<div class="mt-4 flex gap-2 flex-wrap">';
          state.contest.problems.forEach((p, i) => {
            const r = myBoard.problemResults[p.id];
            html += '<div class="problem-cell rounded-lg flex flex-col items-center justify-center px-3 py-2 ' + (r.status === 'pending' ? 'problem-pending' : r.status === 'correct' ? 'problem-correct' : r.status === 'partial' ? 'problem-partial' : r.status === 'wrong' ? 'problem-wrong' : 'bg-gray-800/30') + '"><span class="font-bold text-white">' + String.fromCharCode(65+i) + '</span><span class="text-xs text-white/80">' + (r.score || '‚Äî') + '</span></div>';
          });
          html += '</div>';
        }
        html += '</div>';
      } else {
        html += '<div class="modal-content rounded-xl p-4 mb-6 text-center"><p class="text-gray-400">üìù Write <span class="font-mono text-cyan-400">team:{your name}</span> on paper</p></div>';
      }
      
      if (started && !ended) {
        html += '<div class="modal-content rounded-2xl p-6 mb-6"><h2 class="text-xl font-bold text-white mb-4">Submit Solution</h2>';
        html += '<div class="mb-4"><label class="block text-sm font-medium text-gray-300 mb-2">Select Problem</label><div class="grid grid-cols-' + Math.min(state.contest.problems.length, 5) + ' gap-2">';
        state.contest.problems.forEach((p, i) => {
          html += '<button class="problem-select-btn p-3 rounded-lg border-2 border-gray-700 hover:border-cyan-500 transition text-center" data-problem-id="' + p.id + '"><span class="block text-xl font-bold text-cyan-400">' + String.fromCharCode(65+i) + '</span><span class="block text-xs text-gray-400 truncate">' + p.name + '</span></button>';
        });
        html += '</div></div>';
        html += '<div id="problem-preview" class="hidden mb-4 p-4 rounded-lg bg-gray-800/50 border border-gray-700"><p class="text-sm text-gray-400 mb-2">Problem:</p><img id="problem-image" class="max-h-48 mx-auto rounded"></div>';
        html += '<div class="mb-4"><label class="block text-sm font-medium text-gray-300 mb-2">Upload Solution Photo</label><label for="solution-upload" class="upload-zone block rounded-xl p-6 cursor-pointer text-center" id="upload-drop-zone"><div id="upload-placeholder"><svg class="mx-auto h-12 w-12 text-gray-500 mb-3" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="text-gray-400">Tap to take photo</span><span class="block text-xs text-gray-500 mt-1">Make sure "team:{name}" is visible!</span></div><div id="upload-preview" class="hidden"><img id="solution-preview" class="max-h-48 mx-auto rounded mb-2"><span class="text-xs text-gray-400">Tap to change</span></div></label><input type="file" id="solution-upload" class="hidden" accept="image/*" capture="environment"></div>';
        html += '<button id="submit-solution" disabled class="w-full py-4 rounded-xl btn-primary text-white font-bold text-lg">üì§ Submit</button>';
        html += '<div id="submit-status" class="hidden mt-4 p-4 rounded-lg"></div></div>';
      }
      
      if (state.contestantTeam) {
        html += '<div class="modal-content rounded-2xl p-6"><h3 class="text-lg font-bold text-white mb-4">Your Submissions</h3><div class="space-y-2 max-h-64 overflow-y-auto">' + renderMySubmissions() + '</div></div>';
      }
      
      html += '</div></div>';
      return html;
    }

    function renderMySubmissions() {
      if (!state.contestantTeam) return '<p class="text-gray-500 text-center">Submit to see history</p>';
      const subs = state.contest.submissions.filter(s => s.teamName === state.contestantTeam).sort((a,b) => b.timestamp - a.timestamp);
      if (subs.length === 0) return '<p class="text-gray-500 text-center">No submissions</p>';
      return subs.map(s => {
        const prob = state.contest.problems.find(p => p.id === s.problemId);
        const idx = state.contest.problems.indexOf(prob);
        return '<div class="flex items-center gap-3 p-3 rounded-lg bg-gray-800/50 border border-gray-700"><span class="w-10 h-10 flex items-center justify-center rounded-lg bg-blue-900/50 text-blue-400 font-bold">' + (idx >= 0 ? String.fromCharCode(65+idx) : '?') + '</span><div class="flex-1"><span class="font-medium text-white">' + (prob?.name || '?') + '</span><span class="block text-xs text-gray-500">' + new Date(s.timestamp).toLocaleTimeString() + '</span></div><div class="text-right">' + (s.status === 'pending' ? '<span class="px-2 py-1 rounded text-xs bg-blue-900 text-blue-300">Judging...</span>' : '<span class="font-mono font-bold text-xl ' + (s.score === 100 ? 'text-green-400' : s.score > 0 ? 'text-yellow-400' : 'text-red-400') + '">' + s.score + '</span>') + '</div></div>';
      }).join('');
    }

    function renderScoreboard() {
      const board = calculateScoreboard(false);
      const frozen = isFreezeTime() || state.contest.isFrozen;
      const started = isContestStarted(), ended = isContestEnded(), remaining = getRemainingTime();
      
      let html = '<div class="min-h-screen p-4 sm:p-6">';
      html += '<div class="flex items-center justify-between mb-6"><div class="flex items-center gap-4"><h1 class="font-display text-2xl sm:text-4xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">' + state.contest.name + '</h1>';
      if (started && !ended) html += '<div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500 status-live"></span><span class="text-green-400 font-medium">LIVE</span></div>';
      else if (ended) html += '<span class="px-3 py-1 rounded-full bg-red-900/50 text-red-400">FINISHED</span>';
      else html += '<span class="px-3 py-1 rounded-full bg-yellow-900/50 text-yellow-400">NOT STARTED</span>';
      if (frozen) html += '<span class="px-3 py-1 rounded-full bg-blue-900/50 text-blue-400">‚ùÑÔ∏è FROZEN</span>';
      html += '</div><div class="flex items-center gap-4">';
      if (started) html += '<div class="px-4 py-2 rounded-lg ' + (frozen ? 'bg-blue-900/50' : 'bg-gray-800/50') + '"><span class="font-mono text-2xl sm:text-3xl timer-display ' + (frozen ? 'timer-frozen' : 'text-cyan-400') + '">' + (ended ? '0:00' : formatTime(remaining)) + '</span></div>';
      html += '<div class="text-xs text-gray-500"><span class="kbd">I</span> Reveal <span class="kbd ml-2">J</span> Undo <span class="kbd ml-2">R</span> All</div></div></div>';
      
      html += '<div class="rounded-xl overflow-hidden border border-blue-900/30 bg-gray-900/50"><table class="w-full"><thead class="leaderboard-header"><tr class="text-left text-xs sm:text-sm text-gray-400 uppercase tracking-wider"><th class="px-3 sm:px-4 py-3 w-16">Rank</th><th class="px-3 sm:px-4 py-3">Team</th>';
      state.contest.problems.forEach((p, i) => { html += '<th class="px-1 sm:px-2 py-3 text-center w-16 sm:w-20"><span class="inline-block w-7 h-7 sm:w-8 sm:h-8 leading-7 sm:leading-8 rounded bg-blue-900/50 text-blue-400 font-bold text-sm">' + String.fromCharCode(65+i) + '</span></th>'; });
      html += '<th class="px-3 sm:px-4 py-3 text-center w-20">Solved</th><th class="px-3 sm:px-4 py-3 text-center w-24">Score</th><th class="px-3 sm:px-4 py-3 text-center w-28">Time</th></tr></thead><tbody>';
      
      if (board.length === 0) html += '<tr><td colspan="' + (state.contest.problems.length + 5) + '" class="text-center py-12 text-gray-500">No teams yet</td></tr>';
      else board.forEach((team, idx) => {
        html += '<tr class="scoreboard-row border-t border-gray-800/50" data-team-name="' + team.name + '"><td class="px-3 sm:px-4 py-3"><span class="font-display font-bold text-lg sm:text-xl ' + (idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : 'text-gray-400') + '">' + (idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : '#' + (idx+1)) + '</span></td><td class="px-3 sm:px-4 py-3"><span class="font-medium text-white text-sm sm:text-base">' + team.name + '</span></td>';
        state.contest.problems.forEach(p => {
          const r = team.problemResults[p.id];
          html += '<td class="px-1 sm:px-2 py-3 text-center"><div class="problem-cell rounded-lg flex flex-col items-center justify-center mx-auto ' + (r.status === 'pending' ? 'problem-pending' : r.status === 'frozen' ? 'problem-frozen' : r.status === 'correct' ? 'problem-correct' : r.status === 'partial' ? 'problem-partial' : r.status === 'wrong' ? 'problem-wrong' : 'bg-gray-800/30') + '">' + (r.status !== 'none' ? '<span class="font-mono font-bold text-white text-xs sm:text-sm">' + (r.status === 'frozen' ? '?' : r.score) + '</span>' + (r.attempts > 0 || r.frozenCount > 0 ? '<span class="text-xs text-white/70">' + (r.status === 'frozen' ? '+' + r.frozenCount : r.status === 'correct' ? formatTime(r.solveTime) : r.attempts > 1 ? '(-' + (r.attempts-1) + ')' : '') + '</span>' : '') : '<span class="text-gray-600">‚Äî</span>') + '</div></td>';
        });
        html += '<td class="px-3 sm:px-4 py-3 text-center"><span class="font-mono font-bold text-base sm:text-lg text-green-400">' + team.solvedCount + '</span><span class="text-gray-500 text-sm">/' + state.contest.problems.length + '</span></td><td class="px-3 sm:px-4 py-3 text-center"><span class="font-mono font-bold text-xl sm:text-2xl text-cyan-400">' + team.totalScore + '</span></td><td class="px-3 sm:px-4 py-3 text-center"><span class="font-mono text-gray-400 text-sm">' + formatTimePenalty(team.totalTime) + '</span></td></tr>';
      });
      html += '</tbody></table></div>';
      
      html += '<div class="mt-4 flex items-center justify-center gap-4 sm:gap-6 flex-wrap text-xs sm:text-sm">';
      [['problem-correct','Correct'],['problem-partial','Partial'],['problem-wrong','Wrong'],['problem-pending','Pending'],['problem-frozen','Frozen']].forEach(([c,l]) => {
        html += '<div class="flex items-center gap-2"><div class="w-5 h-5 sm:w-6 sm:h-6 rounded ' + c + '"></div><span class="text-gray-400">' + l + '</span></div>';
      });
      html += '</div></div>';
      return html;
    }

    let selectedProblemId = null, solutionImageData = null, solutionImageType = null;

    function attachEventListeners() {
      const mode = state.mode || getMode();
      if (mode === 'admin') attachAdminListeners();
      else if (mode === 'contestant') attachContestantListeners();
    }

    function attachAdminListeners() {
      document.getElementById('contest-name')?.addEventListener('change', e => { state.contest.name = e.target.value; });
      document.getElementById('contest-start')?.addEventListener('change', e => { state.contest.startTime = e.target.value ? new Date(e.target.value).toISOString() : null; });
      document.getElementById('contest-duration')?.addEventListener('change', e => { state.contest.duration = parseInt(e.target.value) || 180; });
      document.getElementById('contest-freeze')?.addEventListener('change', e => { state.contest.freezeTime = parseInt(e.target.value) || 30; });
      document.getElementById('partial-credit')?.addEventListener('change', e => { state.contest.partialCredit = e.target.checked; });
      document.getElementById('save-settings')?.addEventListener('click', () => { saveContest(); alert('Saved!'); });
      document.getElementById('add-problem')?.addEventListener('click', () => { state.contest.problems.push({ id: generateId(), name: 'Problem ' + (state.contest.problems.length + 1), points: 100, imageData: null, imageType: null }); saveContest(); render(); });
      document.querySelectorAll('[data-remove-problem]').forEach(btn => { btn.addEventListener('click', () => { state.contest.problems = state.contest.problems.filter(p => p.id !== btn.dataset.removeProblem); saveContest(); render(); }); });
      document.querySelectorAll('[data-field][data-pid]').forEach(inp => { inp.addEventListener('change', e => { const p = state.contest.problems.find(x => x.id === e.target.dataset.pid); if (p) { p[e.target.dataset.field] = e.target.dataset.field === 'points' ? parseInt(e.target.value) : e.target.value; saveContest(); } }); });
      document.querySelectorAll('[data-upload-problem]').forEach(lbl => { lbl.addEventListener('click', () => { document.querySelector('[data-problem-upload="' + lbl.dataset.uploadProblem + '"]')?.click(); }); });
      document.querySelectorAll('[data-problem-upload]').forEach(inp => { inp.addEventListener('change', e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = ev => { const p = state.contest.problems.find(x => x.id === e.target.dataset.problemUpload); if (p) { p.imageData = ev.target.result.split(',')[1]; p.imageType = file.type; saveContest(); render(); } }; reader.readAsDataURL(file); }); });
      document.getElementById('toggle-freeze')?.addEventListener('click', () => { state.contest.isFrozen = !state.contest.isFrozen; saveContest(); render(); });
      document.getElementById('clear-data')?.addEventListener('click', () => { if (confirm('Clear all data?')) { state.contest.teams = {}; state.contest.submissions = []; saveContest(); render(); } });
    }

    function attachContestantListeners() {
      document.querySelectorAll('.problem-select-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.problem-select-btn').forEach(b => b.classList.remove('border-cyan-500', 'bg-cyan-900/30'));
          btn.classList.add('border-cyan-500', 'bg-cyan-900/30');
          selectedProblemId = btn.dataset.problemId;
          const prob = state.contest.problems.find(p => p.id === selectedProblemId);
          const preview = document.getElementById('problem-preview'), img = document.getElementById('problem-image');
          if (prob?.imageData && preview && img) { img.src = 'data:' + prob.imageType + ';base64,' + prob.imageData; preview.classList.remove('hidden'); }
          updateSubmitBtn();
        });
      });
      const uploadInput = document.getElementById('solution-upload');
      uploadInput?.addEventListener('change', e => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          solutionImageData = ev.target.result.split(',')[1]; solutionImageType = file.type;
          document.getElementById('upload-placeholder')?.classList.add('hidden');
          const prevDiv = document.getElementById('upload-preview'), prevImg = document.getElementById('solution-preview');
          if (prevDiv && prevImg) { prevImg.src = ev.target.result; prevDiv.classList.remove('hidden'); }
          updateSubmitBtn();
        };
        reader.readAsDataURL(file);
      });
      document.getElementById('submit-solution')?.addEventListener('click', submitSolution);
    }

    function updateSubmitBtn() { const btn = document.getElementById('submit-solution'); if (btn) btn.disabled = !selectedProblemId || !solutionImageData; }

    async function submitSolution() {
      if (!selectedProblemId || !solutionImageData) return;
      const btn = document.getElementById('submit-solution'), status = document.getElementById('submit-status');
      btn.disabled = true; btn.innerHTML = '‚è≥ Grading...';
      status.classList.remove('hidden'); status.className = 'mt-4 p-4 rounded-lg bg-blue-900/30 text-blue-300'; status.textContent = 'AI is grading...';
      
      const sub = { id: generateId(), problemId: selectedProblemId, timestamp: Date.now(), imageData: solutionImageData, imageType: solutionImageType, status: 'pending', teamName: null, score: null, feedback: null };
      const prob = state.contest.problems.find(p => p.id === selectedProblemId);
      const result = await gradeSubmission(sub, prob);
      
      sub.score = result.score; sub.feedback = result.feedback; sub.teamName = result.teamName; sub.status = 'judged';
      if (result.teamName && !state.contest.teams[result.teamName]) state.contest.teams[result.teamName] = { id: generateId(), name: result.teamName, firstSeen: Date.now() };
      if (result.teamName) { state.contestantTeam = result.teamName; localStorage.setItem('contestant_team', result.teamName); }
      state.contest.submissions.push(sub); saveContest();
      
      if (!result.teamName) { status.className = 'mt-4 p-4 rounded-lg bg-yellow-900/30 text-yellow-300'; status.innerHTML = '<p class="font-bold">‚ö†Ô∏è Could not detect team</p><p class="text-sm mt-1">Write "team:{name}" clearly</p><p class="text-sm">Score: ' + result.score + ' - ' + result.feedback + '</p>'; }
      else { status.className = 'mt-4 p-4 rounded-lg ' + (result.score === 100 ? 'bg-green-900/30 text-green-300' : result.score > 0 ? 'bg-yellow-900/30 text-yellow-300' : 'bg-red-900/30 text-red-300'); status.innerHTML = '<div class="flex items-center justify-between mb-2"><span class="font-bold">Team: ' + result.teamName + '</span><span class="text-2xl font-bold">' + result.score + '/100 ' + (result.score === 100 ? '‚úÖ' : result.score > 0 ? '‚ö†Ô∏è' : '‚ùå') + '</span></div><p class="text-sm opacity-80">' + result.feedback + '</p>'; }
      
      selectedProblemId = null; solutionImageData = null; solutionImageType = null;
      btn.innerHTML = 'üì§ Submit';
      setTimeout(() => render(), 2000);
    }

    document.addEventListener('keydown', async e => {
      if (getMode() !== 'scoreboard') return;
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.key.toLowerCase() === 'i') await revealNext();
      else if (e.key.toLowerCase() === 'j') undoReveal();
      else if (e.key.toLowerCase() === 'r') await revealAll();
    });

    function getFrozenSubs() {
      const startMs = new Date(state.contest.startTime).getTime();
      const freezeStart = (state.contest.duration - state.contest.freezeTime) * 60;
      return state.contest.submissions.filter(s => { const e = Math.floor((s.timestamp - startMs) / 1000); return e >= freezeStart && s.status === 'judged'; }).sort((a,b) => a.timestamp - b.timestamp);
    }

    async function revealNext() {
      const frozen = getFrozenSubs(); if (frozen.length === 0) return;
      const sub = frozen[0];
      state.judgeHistory.push({ id: sub.id, status: sub.status });
      sub.status = 'revealed'; saveContest(); render();
      setTimeout(() => { document.querySelectorAll('.scoreboard-row').forEach(r => { r.classList.add('rank-changed'); setTimeout(() => r.classList.remove('rank-changed'), 1500); }); }, 50);
    }

    function undoReveal() {
      if (state.judgeHistory.length === 0) return;
      const last = state.judgeHistory.pop();
      const sub = state.contest.submissions.find(s => s.id === last.id);
      if (sub) { sub.status = 'judged'; saveContest(); render(); }
    }

    async function revealAll() {
      getFrozenSubs().forEach(sub => { state.judgeHistory.push({ id: sub.id, status: sub.status }); sub.status = 'revealed'; });
      state.contest.isFrozen = false; saveContest(); render();
    }

    function startTimer() {
      setInterval(() => {
        loadContest();
        const mode = getMode();
        if (mode === 'scoreboard' || mode === 'contestant') {
          const el = document.querySelector('.timer-display');
          if (el && isContestStarted()) { const r = getRemainingTime(); el.textContent = r <= 0 ? '0:00' : formatTime(r); el.classList.toggle('timer-frozen', isFreezeTime()); }
        }
        if (mode === 'scoreboard') render();
      }, 1000);
    }

    function init() {
      loadContest();
      const saved = localStorage.getItem('contestant_team');
      if (saved && state.contest.teams[saved]) state.contestantTeam = saved;
      state.mode = getMode();
      render();
      startTimer();
    }

    init();
  </script>
</body>
</html>
